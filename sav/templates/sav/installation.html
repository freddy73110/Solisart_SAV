<!DOCTYPE html>
{% extends "sav/base.html" %}
{% load crispy_forms_tags %}
{% load static %}
{%block Titre%}{{title}}{%endblock%}

{% block toast %}
{%for util in acces%}
{%if util.utilisateur.profil_user.evaluation_self or util.utilisateur.profil_user.evaluation_solisart%}
<div class="p-3" style="z-index: 11">
  <div class="toast" role="alert" aria-live="polite" aria-atomic="true" data-bs-autohide="false">
      <div role="alert" aria-live="assertive" aria-atomic="true" >
        <div class="toast-header">
          <img src="{% static 'image/favicon.ico' %}" class="rounded me-2" alt="...">
          <strong class="me-auto">Solistools</strong>
          <small id="toastSmall"></small>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
          {{util.utilisateur.profil_user.icon|safe}} {{util.utilisateur}}:
          <ul>
            {%if util.utilisateur.profil_user.evaluation_self_star%}
            <li onclick="$($(this).parent().find('ul')[0]).toggleClass('d-none')">Note: {{util.utilisateur.profil_user.evaluation_self_star|safe}}</li>
            <ul class="d-none list-group">
              {% for eval in util.utilisateur.profil_user.last_evaluation_self%}
              <li class="list-group-item">
                <b>{{eval.critere}}:</b>
                <span class="fa-layers fa-fw fa-2x" style="color:yellow">
                  <i class="fas fa-star"></i>
                  <span class="fa-layers-text" data-fa-transform="shrink-8" style="font-weight:1200; color:black">{{eval.note}}</span>
                </span><br>
                {{eval.commentaire}}</li>
              {%endfor%}
            </ul>
            {%endif%}
            {%if util.utilisateur.profil_user.evaluation_solisart_star%}
            <li>Appréciation Solisart: {{util.utilisateur.profil_user.evaluation_solisart_star|safe}}</li>
            <ul>
              {% for eval in util.utilisateur.profil_user.last_evaluation_solisart%}
              <li>{{eval.critere}}: {{eval.note}} - {{eval.commentaire}}</li>
              {%endfor%}
            </ul>
            {%endif%}
          </ul>
        </div>
      </div>
  </div>
</div>
<script>
  var toastElList = [].slice.call(document.querySelectorAll('.toast'))
    var toastList = toastElList.map(function(toastEl) {
      return new bootstrap.Toast(toastEl)
    })
    toastList.forEach(toast => toast.show())
</script>
{%endif%}
{%endfor%}
{%endblock%}

{%block article%}
<div class="container">
    <div class="row">
        <div class="col">
            <h1 class="text-center m-3">{{title}}</h1>
            <div class="row justify-content-center">
                <div class="col-6">
                  <div class="col-12 text-center m-3">
                      <a href="https://my.solisart.fr/admin/?page=installation&id={{instal.idsa}}"
                        class="btn btn-outline-primary m-auto"
                        target="_blank"
                      >
                            <img src="{% static 'image/logo-solisart.png' %}" alt="logo solisart" class="rounded mx-auto d-block">
                              lien vers mySolisArt
                        </a>
                  </div>
                </div>
                <div class="col-6">
                  <div class="col-12 text-center m-3">
                    <a href="{%url 'sav:tools' %}"
                    class="btn btn-outline-primary m-auto"
                    target="_blank"
                    >
                    <img src="{% static 'image/icon.ico' %}" alt="logo solisgraph" class="rounded mx-auto d-block" style="max-height: 75px">lien vers SolisGraph
                </a>
              </div>
                    {% comment %} {%for i in month_list%}
                    <div class="form-check form-check-inline">
                      <input class="form-check-input solisgraphmonth" type="checkbox" id="inlineCheckbox{{i}}" value="{{i}}" {% if forloop.counter == 1%} checked {%endif%} {% if forloop.counter > 2%} disabled{%endif%}>
                      <label class="form-check-label" for="inlineCheckbox{{i}}">{{i}}</label>
                    </div>
                    {%endfor%}

                    <script>
                        $(".solisgraphmonth").on("change", function(){
                            console.log('nb checked',$(".solisgraphmonth:checked").length )
                            if ($(".solisgraphmonth:checked").length == 2){
                                $(".solisgraphmonth:not(:checked)").prop('disabled', true)
                            }else if($(".solisgraphmonth:checked").length == 1){
                                var pp = $.map( $(".solisgraphmonth"), function( val, i ) {
                                  return $(val).prop('checked')
                                });
                                $(".solisgraphmonth:not(:checked)").prop('disabled', true)
                                $.each(pp, function(i, v){
                                    if(i != pp.length - 1 && i>0 && v == true){
                                            $($(".solisgraphmonth")[i-1]).prop('disabled', false)
                                            $($(".solisgraphmonth")[i]).prop('disabled', false)
                                            $($(".solisgraphmonth")[i+1]).prop('disabled', false)
                                    }else if(i != pp.length - 1 && v == true){
                                            $($(".solisgraphmonth")[i]).prop('disabled', false)
                                            $($(".solisgraphmonth")[i+1]).prop('disabled', false)
                                    }else if(i>0 && v == true){
                                            $($(".solisgraphmonth")[i]).prop('disabled', false)
                                            $($(".solisgraphmonth")[i-1]).prop('disabled', false)
                                    }
                                })
                            }else{
                                $(".solisgraphmonth:not(:checked)").prop('disabled', false)
                            }
                        })
                        function startsolisgraph(){
                            var url = '{{ request.scheme }}://{{ request.META.HTTP_HOST }}/tools/{{instal.pk}}/'
                            $.each($(".solisgraphmonth:checked"), function(i, v){
                                    url = url + $(v).val()
                                    if (i != $(".solisgraphmonth:checked").length-1){
                                        url =url+'_'
                                    }
                            })
                            window.open(url, '_blank')
                        }
                    </script> {% endcomment %}
                </div>

            {% if instal.schema_installation %}
            <script>

            // If absolute URL from the remote server is provided, configure the CORS
// header on that server.
var url = '{{instal.schema_installation.url}}';

// Loaded via <script> tag, create shortcut to access PDF.js exports.
var pdfjsLib = window['pdfjs-dist/build/pdf'];

// The workerSrc property shall be specified.
pdfjsLib.GlobalWorkerOptions.workerSrc = '//mozilla.github.io/pdf.js/build/pdf.worker.js';

// Asynchronous download of PDF
var loadingTask = pdfjsLib.getDocument(url);
loadingTask.promise.then(function(pdf) {
  console.log('PDF loaded');

  // Fetch the first page
  var pageNumber = 1;
  pdf.getPage(pageNumber).then(function(page) {
    console.log('Page loaded');

    var scale = 1.5;
    var viewport = page.getViewport({scale: scale});

    // Prepare canvas using PDF page dimensions
    var canvas = document.getElementById('the-canvas');
    var context = canvas.getContext('2d');
    canvas.height = viewport.height;
    canvas.width = viewport.width;

    // Render PDF page into canvas context
    var renderContext = {
      canvasContext: context,
      viewport: viewport
    };
    var renderTask = page.render(renderContext);
    renderTask.promise.then(function () {
      console.log('Page rendered');
    });
  });
}, function (reason) {
  // PDF loading error
  console.error(reason);
});
</script>





            {%endif%}
        </div>
    </div>
</div>
<div class="container">
    <div class="row">
        <div class="col">
            <ul class="nav nav-pills nav-justified" id="myTab" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="description-tab" data-bs-toggle="tab" data-bs-target="#description" type="button" role="tab" aria-controls="home" aria-selected="true">Description</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="historique-tab" data-bs-toggle="tab" data-bs-target="#historique" type="button" role="tab" aria-controls="profile" aria-selected="false">
                    <span>Historique
                        <span class="badge rounded-pill bg-success" tabindex="0" data-bs-toggle="popover" data-bs-trigger="hover focus" title="Mise en Service" data-bs-content="Mises en service faites">
                        {{ instal.MES_count }}
                        </span>
                        <span class="badge rounded-pill bg-warning" tabindex="0" data-bs-toggle="popover" data-bs-trigger="hover focus" title="Tickets ouverts" data-bs-content="Tickets réglés">
                        {{ instal.ticket_count }}
                        </span>
                        <span class="badge rounded-pill bg-danger" tabindex="0" data-bs-container="body" data-bs-placement="top" data-bs-toggle="popover" data-bs-trigger="hover focus" title="Tickets en cours" data-bs-content="Tickets qui restent à régler">
                        {{ instal.ticket_open_count }}
                        </span>
                    </span>
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="acces-tab" data-bs-toggle="tab" data-bs-target="#acces" type="button" role="tab" aria-controls="profile" aria-selected="false">
                    <span>Accès
                        <span class="badge rounded-pill bg-success" tabindex="0" data-bs-container="body" data-bs-placement="top" data-bs-toggle="popover" data-bs-trigger="hover focus" title="Accès" data-bs-content="Nombre de personne à pouvoir accéder à l'installation">
                        {{ acces|length }}
                        </span>
                    </span>
                </button>
              </li>
                {%if CL %}
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="CL-tab" data-bs-toggle="tab" data-bs-target="#CL" type="button" role="tab" aria-controls="profile" aria-selected="false">
                  Bon de  commande lié
                  {%if instal.default_tracability%}<i class="fas fa-exclamation-triangle text-danger beatanimation"></i>{%endif%}
                </button>
              </li>
                {%endif%}
                {%if instal.noncompliance %}
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="Noncompliance-tab" data-bs-toggle="tab" data-bs-target="#navNoncompliance" type="button" role="tab" aria-controls="profile" aria-selected="false">
                  <span>Non Conformité
                    <span class="badge rounded-pill bg-danger" tabindex="0" data-bs-container="body" data-bs-placement="top" data-bs-toggle="popover" data-bs-trigger="hover focus" title="Non Conformité" data-bs-content="Nombre de Non conformité sur cette installation">
                    {{ instal.noncompliance|length }}
                    </span>
                </span>
               </button>
              </li>
                {%endif%}
            </ul>
        </div>
    </div>
    <div class="row">
        <div class="col">
            <div class="tab-content" id="myTabContent">
                <div class="modal fade" id="ModalEvenement" tabindex="-1" aria-labelledby="ModalEvenementLabel" aria-hidden="true">
                      <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                          <div class="modal-header bg-warning">
                            <h5 class="modal-title" id="ModalEvenementLabel">New message</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                          </div>
                            <form method="post">
                          <div class="modal-body">
                              <input type="hidden" value="" name="nature_form">
                              <div id="update_ticket">
                                  <div class="mb-3" id="add_evenement_modal">
                                    {% crispy add_evenement %}
                                  </div>
                                    <div id="ticket_modal" name="modal_form">
                                    {% crispy add_ticket_form %}
                                    </div>
                              </div>
                                <div id="MES_modal" name="modal_form">
                                    {%crispy add_MES_form %}
                                </div>
                                <div id="production_modal" name="modal_form">
                                </div>
                                <div id="photos" ></div>
                                <div id="evalutionFormDiv"></div>
                              <div id="delete_file_modal">
                                <input type="hidden" id="delete_file_input" name="delete_file_input">
                              </div>
                              <div id="rename_file_modal">
                                <input type="hidden" id="rename_file_input" name="rename_file_input">
                                <div class="input-group mb-3">
                                    <div class="form-floating flex-grow-1">
                                        <input type="text"
                                         class="form-control"
                                         name='new_name'
                                         id="new_name"
                                         placeholder="Nouveau nom du fichier"
                                         aria-label="Username"
                                         aria-describedby="basic-addon1">
                                        <label for="new_name">Nouveau nom du fichier</label>
                                    </div>

                                </div>
                              </div>
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Fermer</button>
                            <button type="button" class="btn btn-outline-primary" id="enregister">Enregister</button>
                            <script>
                                $("#enregister").on("click", function(){
                                  hh = $(this).closest("form")[0]
                                  
                                  console.log(hh)
                                   var d = new FormData(hh)
                                  if($("#InputNoncompliance").is(':checked')){
                                      d.append('Noncompliance', '0')
                                  } 
                                    var form = $(this).closest("form");
                                      $.ajax({
                                        url: window.location.href,
                                        data: d,
                                        dataType: 'json',
                                        type: 'Post',
                                        processData: false,
                                        contentType: false,
                                        success: function (data) {
                                          $("#ModalEvenement").hide()
                                          if (data.hasOwnProperty('evaluation')){
                                            location.reload()
                                          }
                                          if (data.hasOwnProperty('probleme')){
                                            $("#add_evenement_modal").show()
                                            $("[name='sous_categorie']").val("")
                                            $('#id_probleme').append($('<option>', {
                                                value: data.probleme.id,
                                                text: 'data.probleme.title'
                                            }));
                                            $('#id_probleme').val(data.probleme.id)
                                          }

                                           if (data.hasOwnProperty('mes')&&data.mes=="ok"){
                                            location.reload()
                                          }else{
                                            $("#ModalEvenement").show()
                                            $(".is-invalid").removeClass("is-invalid")
                                            $("small").remove()
                                            $.each(data.error, function(index, value){
                                                $("[name="+index+"]").addClass("is-invalid").removeClass("is-valid").after("<small class='text-danger'>"+value+"</small>")
                                            })
                                          }
                                          if (data.hasOwnProperty('ticket')&&data.ticket=="ok"){
                                            location.reload()
                                          }else{
                                            $("#ModalEvenement").show()
                                            $(".is-invalid").removeClass("is-invalid")
                                            $("small").remove()
                                            $.each(data.error, function(index, value){
                                                $("[name="+index+"]").addClass("is-invalid").removeClass("is-valid").after("<small class='text-danger'>"+value+"</small>")
                                            })
                                          }
                                          if(data.hasOwnProperty('deleted')){
                                                location.reload()
                                          }
                                          if(data.hasOwnProperty('renamed')){
                                                location.reload()
                                          }
                                          if(data.hasOwnProperty('update_ticket')){
                                                location.reload()
                                          }
                                        }
                                      });
                                })
                            </script>
                          </div>
                            </form>
                        </div>
                      </div>
                </div>
                {%if instal.noncompliance %}
                <div class="tab-pane fade " id="navNoncompliance" role="tabpanel" aria-labelledby="home-tab">
                  <h1>Non Conformité</h1>
                  <table
                    data-toggle="table"
                    data-search="true"
                    data-show-columns="true"
                    data-show-columns-toggle-all="true"
                    data-show-refresh="false"
                    data-show-fullscreen="true"
                    data-show-export="true"
                    data-page-list="[10, 25, 50, 100, all]"
                    data-pagination="true"
                    data-filter-control="true"
                    data-show-search-clear-button="true">
                <thead>
                    <th class="text-center">Numéro</th>
                    <th class="text-center">Date</th>
                    <th class="text-center">référence</th>
                </thead>
                <tbody>
                  {%for NC in instal.noncompliance%}
                  <tr>
                    <td class="text-center">
                      <a data-bs-toggle="modal"
                      data-bs-target="#ModalEvenement"
                      data-bs-whatever="ticket"
                      href="#" 
                      onclick="updateTicket({{NC.ticket.id}})"
                      >{{NC.numero}}</a></td>
                    <td class="text-center">{{NC.ticket.evenement.date}}</td>  
                    <td class="text-center">{{NC.ref_herakles}}</td>  
                  </tr>
                  {%endfor%}
                </tbody>
              </table>
                </div> 
                {%endif%} 
              <div class="tab-pane fade " id="description" role="tabpanel" aria-labelledby="home-tab">
                  <div class="accordion m-3" id="accordionPanelsStayOpenExample">
                      <div class="accordion-item">
                        <h2 class="accordion-header" id="panelsStayOpen-headingOne">
                          <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseOne" aria-expanded="true" aria-controls="panelsStayOpen-collapseOne">
                            <b>Information de "my.solisart"</b>
                          </button>
                        </h2>
                        <div id="panelsStayOpen-collapseOne" class="accordion-collapse collapse show" aria-labelledby="panelsStayOpen-headingOne">
                          <div class="accordion-body">
                            <table
                    data-toolbar="#toolbar"
                    data-toggle="table"
                    data-search="true"
                    data-show-columns="true"
                    data-show-columns-toggle-all="true"
                    data-show-refresh="false"
                    data-show-fullscreen="true"
                    data-show-export="true"
                    data-page-list="[10, 25, 50, 100, all]"
                    data-pagination="true"
                    data-filter-control="true"
                    data-show-search-clear-button="true">
                <thead>
                    <th>Description</th>
                    <th>Valeur</th>
                </thead>
                <tbody>
                    {% for i in attribut_val %}
                    <tr>
                        <td>{{i.attribut_def}}</td>
                        <td>{%if i.attribut_def.description == "Coordonnées GPS DD" %}
                            <form>{% csrf_token %}
                                <div class="input-group mb-3">
                                    <input type="hidden" value="{{i.id}}" name="GPS_id">
                                  <input
                                          type="text"
                                          class="form-control"
                                          id="GPS"
                                          name="CoordonneeGPS"
                                          value="{{i.valeur}}"
                                          placeholder="Recipient's username"
                                          aria-label="Recipient's username"
                                          aria-describedby="button-addon2"
                                  >
                                  <button class="btn btn-outline-secondary" type="button" id="GPSValider" onclick="modifierGPS()">Valider</button>
                                </div>
                            </form>
                            {%else%}
                            {{i.valeur}}
                            {%endif%}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
                          </div>
                        </div>
                      </div>
                      <div class="accordion-item">
                        <h2 class="accordion-header" id="panelsStayOpen-headingTwo">
                          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseTwo" aria-expanded="false" aria-controls="panelsStayOpen-collapseTwo">
                            <b>Autre</b>
                          </button>
                        </h2>
                        <div id="panelsStayOpen-collapseTwo" class="accordion-collapse collapse" aria-labelledby="panelsStayOpen-headingTwo">
                          <div class="accordion-body">
                              {% crispy form %}
                          </div>
                        </div>
                      </div>
                  </div>
              </div>
              <div class="tab-pane fade m-3 show active" id="historique" role="tabpanel" aria-labelledby="profile-tab">
                  <button type="button"
                          class="btn btn-outline-primary"
                          data-bs-toggle="modal"
                          data-bs-target="#ModalEvenement"
                          data-bs-whatever="ticket"
                          onclick="initticketform(this)"  ><i class="fas fa-tag"></i> Ajouter un ticket
                  </button>
                  <button type="button"
                          class="btn btn-outline-primary"
                          data-bs-toggle="modal"
                          data-bs-target="#ModalEvenement"
                          data-bs-whatever="MES"
                          ><i class="fas fa-rocket"></i> Ajouter une MES
                  </button>


                  <div class="accordion m-3 " id="accordionExample">
                      {%for e in liste_evenements %}
                      {%if e.ticket%}
                      <div class="accordion-item">
                        <h2 class="accordion-header" id="headingOne">
                          <button class="accordion-button " type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ forloop.counter }}" aria-expanded="true" aria-controls="collapse{{ forloop.counter }}">
                              <b>{{e.ticket.icon_etat|safe}} {{e.ticket.icon_forme|safe}} {{e.ticket.icon|safe}} {{e.ticket.probleme}} {% if e.ticket.cause %}{{e.ticket.cause}} {%endif%}{{e.ticket.utilisateur}}</b>
                              <i class="far fa-calendar-alt m-1"></i> {{e.date|date:"d-m-Y"}}
                              <i class="far fa-clock m-1"></i> {{e.date|time:"H:i"}}
                              <b>{{e.ticket.icon_technicien_sav|safe}}</b>
                          </button>
                        </h2>
                        <div id="collapse{{ forloop.counter }}" id="ticket_{{e.ticket.id}}" class="accordion-collapse collapse {% if forloop.first %}show{%endif%} upload-zone" aria-labelledby="headingOne" data-bs-parent="#accordionExample">
                          <div class="accordion-body">
                              <input class="fileupload" type="file" name="fichier" multiple
                                 style="display: none;"
                                 data-url="{{ request.get_full_path }}"
                                 data-form-data='{"csrfmiddlewaretoken": "{{ csrf_token }}", "file_ticket":{{e.ticket.id}}}'
                              >
                              <p></p>
                              <div class="row">
                                  <div class="col-{%if e.ticket.fichier.all.count or e.ticket.devis or e.ticket.BL  or e.ticket.NC %}8{%else%}12{%endif%}">
                                  <button class="btn btn-outline-primary m-1"
                                          type="button"
                                          data-bs-toggle="modal"
                                          data-bs-target="#ModalEvenement"
                                          data-bs-whatever="ticket"
                                          onclick="updateTicket({{e.ticket.id}})"
                                  ><i class="fas fa-wrench" ></i> Mettre à jour</button>
                                  <button class="btn btn-outline-primary m-1" onclick="$(this).closest('.accordion-body').find('.fileupload').click()"><i class="fa fa-plus-circle" aria-hidden="true"></i> Ajouter des fichiers</button>
                                  <div class="form-floating">
                                      <textarea class="form-control textarea_update" id="ta_ticket_{{e.ticket.id}}" onchange="growall($(this))" spellcheck="true">{{e.ticket.detail}}</textarea>
                                  </div>
                                  </div>
                                  {%if e.ticket.fichier.all.count or e.ticket.devis or e.ticket.BL or e.ticket.NC %}
                                  <div class="col-4">
                                      <div class="row">
                                          <div class="col-12">
                                        {%if e.ticket.devis or e.ticket.BL%}
                                            {%for d in e.ticket.devis.all%}
                                                <button type="button" class="btn btn-secondary devis" devis="{{d}}" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">
                                                  {{d}}
                                                </button>
                                            {% endfor %}
                                            {%for B in e.ticket.BL.all%}
                                                <button type="button" class="btn btn-secondary BL" BL="{{B}}" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">
                                                  {{B}}
                                                </button>
                                            {% endfor %}
                                            {%if e.ticket.NC%}
                                            <button type="button" class="btn btn-warning BL" >
                                              {{e.ticket.NC}}
                                            </button>
                                            {%endif%}
                                        {%endif%}
                                              </div>
                                          </div>
                                          <div class="row">
                                          <div class="col-12">

                                        {%if e.ticket.fichier.all.count %}
                                        <button type="button" class="btn btn-outline-primary mt-3 mb-3" id="buttonAllDownload{{e.ticket.id}}" onclick="alldownload({{e.ticket.id}})"><i class="fas fa-cloud-download-alt"></i> Tout télécharger</button><br>
                                      {%for f in e.ticket.fichier.all%}
                                        {%if '.jpeg' in f.fichier.name|lower or '.png' in f.fichier.name|lower  or 'jpg' in f.fichier.name|lower %}
                                                <a href="#" data-bs-toggle="modal" data-bs-target="#ModalEvenement" data-bs-whatever="ticket" onclick="ShowModalImage({{e.ticket.id}}, {{f.id}}, 'ticket')">{{f.icon|safe}} {{f.titre}}</a> (<i
                                              class="far fa-trash-alt deletefile"
                                              id="deletefile_{{f.id}}"
                                              onclick="deletefile(this)"
                                              file_name="{{f.titre}}"
                                            data-bs-toggle="modal" data-bs-target="#ModalEvenement" data-bs-whatever="ticket"></i> - <i
                                              class="fas fa-pen renamefile"
                                              id="renamefile_{{f.id}}"
                                              onclick="renamefile(this)"
                                              file_name="{{f.titre}}"
                                              data-bs-toggle="modal" data-bs-target="#ModalEvenement" data-bs-whatever="ticket"
                                      ></i>)
                                          {% if not forloop.last %}<br>{%endif%}
                                        {% else %}
                                      <a href="{{f.fichier.url}}">{{f.icon|safe}} {{f.titre}}</a> (<i
                                          class="far fa-trash-alt deletefile"
                                          id="deletefile_{{f.id}}"
                                          onclick="deletefile(this)"
                                          file_name="{{f.titre}}"
                                        data-bs-toggle="modal" data-bs-target="#ModalEvenement" data-bs-whatever="ticket"></i> - <i
                                          class="fas fa-pen renamefile"
                                          id="renamefile_{{f.id}}"
                                          onclick="renamefile(this)"
                                          file_name="{{f.titre}}"
                                          data-bs-toggle="modal" data-bs-target="#ModalEvenement" data-bs-whatever="ticket"
                                  ></i>)
                                      {% if not forloop.last %}<br>{%endif%}

                                      {% endif %}
                                      {%endfor%}
                                      {% endif %}
                                  </div>
                                              </div>
                                          </div>
                                  {%endif%}
                              </div>
                          </div>
                        </div>
                      </div>
                      {%endif%}
                      {%if e.MES%}
                      <div class="accordion-item">
                        <h2 class="accordion-header">
                          <button class="accordion-button " type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ forloop.counter }}" aria-expanded="true" aria-controls="collapse{{ forloop.counter }}">
                              <b>Mise en Service</b>
                              <i class="far fa-calendar-alt m-1"></i> {{e.date|date:"d-m-Y"}}
                              <i class="far fa-clock m-1"></i> {{e.date|time:"H:i"}}
                              <b>{{e.MES.icon_technicien_sav|safe}}</b>
                          </button>
                        </h2>
                        <div id="collapse{{ forloop.counter }}" id="MES_{{e.MES.id}}" class="accordion-collapse collapse {% if forloop.first %}show{%endif%} upload-zone" aria-labelledby="headingOne" data-bs-parent="#accordionExample">
                          <div class="accordion-body">
                              <input class="fileupload" type="file" name="fichier" multiple
                                 style="display: none;"
                                 data-url="{{ request.get_full_path }}"
                                 data-form-data='{"csrfmiddlewaretoken": "{{ csrf_token }}", "file_MES":{{e.MES.id}}}'
                              >
                              <p></p>
                              <div class="row">
                                  <div class="col-{%if e.MES.fichier.all.count %}8{%else%}12{%endif%}">
                                  <button class="btn btn-outline-primary m-1" onclick="$(this).closest('.accordion-body').find('.fileupload').click()"><i class="fa fa-plus-circle" aria-hidden="true"></i> Ajouter des fichiers</button>
                                  <div class="form-floating">
                                      <textarea class="form-control textarea_update" id="ta_MES_{{e.MES.id}}" onchange="growall($(this))" spellcheck="true">{{e.MES.detail}}</textarea>
                                  </div>
                                  </div>
                                  {%if e.MES.fichier.all.count %}
                                  <div class="col-4">
                                      {%for f in e.MES.fichier.all%}
                                      {%if '.jpeg' in f.fichier.name|lower or '.png' in f.fichier.name|lower  or 'jpg' in f.fichier.name|lower %}
                                                <a href="#" data-bs-toggle="modal" data-bs-target="#ModalEvenement" data-bs-whatever="ticket" onclick="ShowModalImage({{e.MES.id}}, {{f.id}}, 'MES')">{{f.icon|safe}} {{f.titre}}</a> (<i
                                              class="far fa-trash-alt deletefile"
                                              id="deletefile_{{f.id}}"
                                              onclick="deletefile(this)"
                                              file_name="{{f.titre}}"
                                            data-bs-toggle="modal" data-bs-target="#ModalEvenement" data-bs-whatever="ticket"></i> - <i
                                              class="fas fa-pen renamefile"
                                              id="renamefile_{{f.id}}"
                                              onclick="renamefile(this)"
                                              file_name="{{f.titre}}"
                                              data-bs-toggle="modal" data-bs-target="#ModalEvenement" data-bs-whatever="ticket"
                                      ></i>)
                                          {% if not forloop.last %}<br>{%endif%}
                                        {% else %}
                                      <a href="{{f.fichier.url}}">{{f.icon|safe}} {{f.titre}}</a> (<i
                                          class="far fa-trash-alt deletefile"
                                          id="deletefile_{{f.id}}"
                                          onclick="deletefile(this)"
                                          file_name="{{f.titre}}"
                                        data-bs-toggle="modal" data-bs-target="#ModalEvenement" data-bs-whatever="ticket"></i> - <i
                                          class="fas fa-pen renamefile"
                                          id="renamefile_{{f.id}}"
                                          onclick="renamefile(this)"
                                          file_name="{{f.titre}}"
                                          data-bs-toggle="modal" data-bs-target="#ModalEvenement" data-bs-whatever="ticket"
                                  ></i>)
                                      {% if not forloop.last %}<br>{%endif%}

                                      {% endif %}
                                      {%endfor%}
                                  </div>
                                  {%endif%}
                              </div>
                          </div>
                        </div>
                      </div>
                      {%endif%}
                      {% endfor %}
                    </div>
                    <script>
                    function Updatedata(t){
                                  $.ajax({
                                        url: window.location.href,
                                        data: {"details": $(t).val(), "id": $(t).attr('id')},
                                        dataType: 'json',
                                        type: 'Post',
                                        success: function (data) {
                                            console.log(data)
                                        }
                                  })

                    }
                    </script>
              </div>
              <div class="tab-pane fade m-3" id="acces" role="tabpanel" aria-labelledby="home-tab">
                  <h1>Acces</h1>
                  <table
                    data-toolbar="#toolbar"
                    data-toggle="table"
                    data-search="true"
                    data-show-columns="true"
                    data-show-columns-toggle-all="true"
                    data-show-refresh="false"
                    data-show-fullscreen="true"
                    data-show-export="true"
                    data-page-list="[10, 25, 50, 100, all]"
                    data-pagination="true"
                    data-filter-control="true"
                    data-show-search-clear-button="true">
                    <thead>
                        <th class="text-center">Statut</th>
                        <th class="text-center">Personne</th>
                        <th class="text-center">Email</th>
                        <th class="text-center">Téléphone</th>
                        <th class="text-center">Evaluation</th>
                    </thead>
                      <tbody>
                        {% for util in acces%}
                        <tr>
                            <td>{{util.profil_type}}</td>
                            <td><a href="{% url 'sav:utilisateur' pk=util.utilisateur.id %}">{{util.utilisateur.profil_user.icon|safe}} {{util.utilisateur}}</a></td>
                            <td>{{util.utilisateur.email}}</td>
                            <td>{{util.utilisateur.profil_user.telephone1}}</td>
                            <td><i class="fas fa-star" style="color:yellow" onclick="evalutionForm({{util.utilisateur.id}})"data-bs-toggle="modal"
                              data-bs-target="#ModalEvenement"
                              data-bs-whatever="ticket"
                              href="#"></i></td>
                        </tr>
                      {%endfor%}

                    </tbody>
                </table>

              </div>
              <div class="tab-pane fade m-3" id="CL" role="tabpanel" aria-labelledby="home-tab">
                  <h1>Bon de  commande lié</h1>
                  <ul class="list-unstyled">
                      <li>N° de commande: <button type="button" class="btn btn-secondary CL" CL="{{CL.0}}" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">{{CL.0}}</button></li>
                  <li>Date de livraison : {{CL.0.date_livraison_prevu}}</li>
                  <li>Fichiers liés:
                      <ul>
                  {% for f in CL.0.fichier.all %}
                  {%if '.jpeg' in f.fichier.name|lower or '.png' in f.fichier.name|lower  or 'jpg' in f.fichier.name|lower %}
                                                <a href="#" data-bs-toggle="modal" data-bs-target="#ModalEvenement" data-bs-whatever="ticket" onclick="ShowModalImage({{CL.0.id}}, {{f.id}}, 'CL')">{{f.icon|safe}} {{f.titre}}</a> (<i
                                              class="far fa-trash-alt deletefile"
                                              id="deletefile_{{f.id}}"
                                              onclick="deletefile(this)"
                                              file_name="{{f.titre}}"
                                            data-bs-toggle="modal" data-bs-target="#ModalEvenement" data-bs-whatever="ticket"></i> - <i
                                              class="fas fa-pen renamefile"
                                              id="renamefile_{{f.id}}"
                                              onclick="renamefile(this)"
                                              file_name="{{f.titre}}"
                                              data-bs-toggle="modal" data-bs-target="#ModalEvenement" data-bs-whatever="ticket"
                                      ></i>)
                                          {% if not forloop.last %}<br>{%endif%}
                                        {% else %}
                                      <a href="{{f.fichier.url}}" download>{{f.icon|safe}} {{f.titre}}</a> (<i
                                          class="far fa-trash-alt deletefile"
                                          id="deletefile_{{f.id}}"
                                          onclick="deletefile(this)"
                                          file_name="{{f.titre}}"
                                        data-bs-toggle="modal" data-bs-target="#ModalEvenement" data-bs-whatever="ticket"></i> - <i
                                          class="fas fa-pen renamefile"
                                          id="renamefile_{{f.id}}"
                                          onclick="renamefile(this)"
                                          file_name="{{f.titre}}"
                                          data-bs-toggle="modal" data-bs-target="#ModalEvenement" data-bs-whatever="ticket"
                                  ></i>)
                                      {% if not forloop.last %}<br>{%endif%}

                                      {% endif %}
                                      {%endfor%}
                          </ul>
                  </li>
                  </ul>
                  {% if instal.tracability %}
                  <div class="row">
                    <div class="col-12">
                      <table 
                            class="table table-bordered table-hover table-striped text-center">
                        <thead>
                            <th>Lot</th>
                            <th>Numéro de Série</th>
                            <th>organe</th>
                            <th>Emplacement</th>
                        </thead>
                        <tbody>
                            {%for t in instal.tracability%}
                            {%if t.batch or t.SN%}
                            <tr >
                                <td {%if t.batch.compliance == False%}class="bg-danger"{%endif%}
                                >{%if t.batch%}<a href="{% url 'sav:batch' %}" >{{t.batch}}</a>{%else%}-{%endif%}</td>
                                <td {%if t.batch.compliance == False%}class="bg-danger"{%endif%}>{%if t.SN%}{{t.SN}}{%else%}-{%endif%}</td>
                                <td {%if t.batch.compliance == False%}class="bg-danger"{%endif%}>{{t.organ}} - {{t.organ.herakles_name}}</td>    
                                <td {%if t.batch.compliance == False%}class="bg-danger"{%endif%}>{{t.location_str}}</td>
                            </tr>
                            {%endif%}
                            {%endfor%}
                        </tbody>
                    </table>
                    </div>
                  </div>
                  {%endif%}

              </div>
            </div>
        </div>
    </div>
</div>
<script>
$("button[data-bs-target='#ModalEvenement']").on("click", function(){
                                        $(".modal-body").find("div").hide()
                                        $("#add_evenement_modal").show()
                                        $("#add_evenement_modal").find('div').show()
                                        $("[name='sous_categorie']").val("")
                                        $("#ModalEvenementLabel").html($(this).text())
                                        $("#enregister").html('Enregister')
                                        if($(this).attr('data-bs-whatever') == 'ticket'){
                                            $("input[name='nature_form']").val('ticket')
                                            $("#ticket_modal").show("show")
                                            $("#ticket_modal").find('div').show("show")
                                        }else if($(this).attr('data-bs-whatever') == 'MES'){
                                            $("input[name='nature_form']").val('MES')
                                            $("#MES_modal").show("show")
                                            $("#update_ticket").show("show")
                                            $("#MES_modal").find('div').show("show")
                                        }
})
function initticketform(me){
    $(".modal-body").find("div").hide()
    $("#update_ticket").html()
    $("#update_ticket").html('<h1><i class="fas fa-sun fa-spin" style="color:yellow"></i></h1>')
    $.ajax({
        url: window.location.href,
            type:'post',
            data: {'nature_form': 'update_ticket_init', 'id':0},
            dataType: 'html',
            success: function (html) {
                $("#update_ticket").html(html)
                $("input[name='nature_form']").val('ticket')
                $("#add_evenement_modal").show("slow")
                $("#update_ticket").show("slow")
                $("#ModalEvenementLabel").html('Enregister un ticket')
                $("#enregister").html('Enregister')
            }
    })
}
function deletefile(me){
    $(".modal-body").find("div").hide()
    $("input[name='nature_form']").val('delete_file')
    $("#ModalEvenementLabel").html('Supprimer définitivement le fichier "' + $(me).attr('file_name') + '"')
    $("#delete_file_input").val($(me)[0].id)
    $("div[name='modal_form']").hide()
    $("#delete_file_modal").show("slow" )
    $("#enregister").html('Supprimer')
}
function renamefile(me){
    $(".modal-body").find("div").hide()
    $("input[name='nature_form']").val('rename_file')
    $("#ModalEvenementLabel").html('Renommer le fichier "' + $(me).attr('file_name')+'"')
    $("#rename_file_input").val($(me)[0].id)
    $("#new_name").val($(me).attr('file_name'))
    $("#rename_file_modal").show("slow")
    $("#rename_file_modal").find('div').show("slow")
    $("#enregister").html('Renommer')
}
function submit_ticket(){
  var d = new FormData($("#ticket_form")[0])
  if($("#InputNoncompliance").is(':checked')){
      d.append('Noncompliance', '0')
  }
  $.ajax({
       url: window.location.href,
       data: d,
       type: 'Post',
       processData: false,
       contentType: false,
       success: function (data) {
             if(data.even == "ok" && data.ticket=="ok"){
                  if(data.ticketChanged.etat == 3){
                      $("#ticket_" + data.ticketChanged.id).closest('tr').remove()
                  }
                  var myModal = bootstrap.Modal.getOrCreateInstance(document.getElementById('Modal'));
                  myModal.hide();
                  if ("ticketChanged" in data){
                      if (data['ticketChanged'] == 3){
                          location.reload()
                      }
                  }        
             }else{
              $.each(data.ticket.error, function(index, value){
                                                  $("[name="+index+"]").addClass("is-invalid").removeClass("is-valid").after("<small class='text-danger'>"+value+"</small>")
                                              })
              $.each(data.even.error, function(index, value){
                                                  $("[name="+index+"]").addClass("is-invalid").removeClass("is-valid").after("<small class='text-danger'>"+value+"</small>")
                                              })
              $.each(data.NC.error, function(index, value){
                                                  $("[name="+index+"]").addClass("is-invalid").removeClass("is-valid").after("<small class='text-danger'>"+value+"</small>")
                                              })                                
             }
       }
  })
  }
function updateTicket(id){
    $(".modal-body").find("div").hide()
    $("#update_ticket").html()
    $("#update_ticket").html('<h1><i class="fas fa-sun fa-spin" style="color:yellow"></i></h1>')
    $.ajax({
        url: window.location.href,
            type:'post',
            data: {'nature_form': 'update_ticket_init', 'id':id},
            dataType: 'html',
            success: function (html) {

            //todo faire un message de validation
                $("#update_ticket").html(html)
                $("input[name='nature_form']").val('update-ticket')
                $("#add_evenement_modal").show("slow" )
                $("#update_ticket").show("slow" )
                $("#ModalEvenementLabel").html('Mettre à jour le ticket')
                $("#enregister").html('Mettre à jour')
            }
    })
}
function modifierGPS(){
    var form = $('#GPSValider').closest("form");
    $.ajax({
            url: window.location.href,
            type:'post',
            data: form.serialize(),
            dataType: 'json',
            success: function (data) {
            //todo faire un message de validation
                console.log(data)
                $('#GPS').addClass("is-valid")
            }
    })
}
$(document).ready(function() {
    $('#GPSValider').on('click', function(){
    var form = $(this).closest("form");
    $.ajax({
            url: window.location.href,
            type:'post',
            data: form.serialize(),
            dataType: 'json',
            success: function (data) {
            //todo faire un message de validation
                console.log(data)
            }
    })
});
});
</script>
<script>
$(document).on('dragover', function (e) {
    e.preventDefault();
    $('.upload-zone').on('dragover', function(event){
    if(!$(this).find('.todelete').length){
            $(this).find('p').first().after('<div class="well text-muted text-center todelete" style="padding-top: 4rem; padding-bottom: 4rem;"><i class="fa fa-arrow-down fa-4x" aria-hidden="true"></i><h3>Déposer vos fichiers ici</h3></div>')
        }
    });
    if (!$(event.target).closest('.upload-zone').length){
        $('.todelete').remove()
    }
});
$('.upload-zone').each(function () {
    var DropZone = $(this);
    var DropZone_id = DropZone[0].id.split('_')[1];
    DropZone.find('input:first').fileupload({
            dropZone: DropZone,
            dataType: 'json',
            sequentialUploads: true,

            start: function (e) {
              $("#modal-progress").modal("show");
            },

            stop: function (e) {
              $("#modal-progress").modal("hide");
            },

            progressall: function (e, data) {
              var progress = parseInt(data.loaded / data.total * 100, 10);
              var strProgress = progress + "%";
              $(".progress-bar").css({"width": strProgress});
              $(".progress-bar").text(strProgress);
              if (progress == 100){
                setTimeout(function(){
                    $("#modal-progress").modal("hide");
                    location.reload()
                }, 1500);
              }
            },
            done: function (e, data) {
              $('.todelete').remove()
              console.log(e, data)
              if (data.is_valid == false){

              }else{

              }

            }
    });
});
</script>
<script>
function alldownload(ticket_id){
    var data = "ticket_id=" + ticket_id + "&alldownload=all"
    $("#buttonAllDownload" + ticket_id).html("<i class='fas fa-sun fa-spin'></i> En téléchargement")
    $.ajax({
            url: window.location.href,
            type:'post',
            data: data,
            xhrFields:{
                responseType: 'blob'
            },
            success: function (response) {
                    var link = document.createElement('a');
                    link.href = window.URL.createObjectURL(response)
                    link.download = 'Ticket.zip';
                    document.body.appendChild(link);
                    link.click();
                    $("#buttonAllDownload" + ticket_id).html("<i class='fas fa-cloud-download-alt'></i> Tout télécharger")
            }

    })
}

function ShowModalImage(id, photo_id, type){
    var data = type + "_id=" + id + "&photoid=" + photo_id
    $.ajax({
            url: window.location.href,
            type:'post',
            data: data,
            dataType: 'html',
            success: function (html) {
            //todo faire un message de validation
                $(".modal-body").find("div").hide()
                $("#ModalEvenementLabel").html("<h2>Photos</h2>")
                $("#photos").html(html)
                $("#photos").show("show")
            }
    })

}

var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
  return new bootstrap.Popover(popoverTriggerEl)
})

</script>
<script>
$(document).ready(function() {
  $('textarea.textarea_update').emojioneArea({
    attributes: {
      spellcheck : true,
      autocomplete   : "on",
  },
    events: {
      change: function(editor, event) {
        txt=editor.html()
        id = $(editor).parent().parent().find('textarea')[0].id
        $($(editor).parent().parent().find('textarea')[0]).html(txt)
        Updatedata($(editor).parent().parent().find('textarea')[0])
      },
      keyup: function(editor, event) {
        txt=editor.html()
        id = $(editor).parent().parent().find('textarea')[0].id
        $($(editor).parent().parent().find('textarea')[0]).html(txt)
        Updatedata($(editor).parent().parent().find('textarea')[0])
      },
      picker_click: function(editor, event) {
        txt=editor.html()
        id = $(editor).parent().parent().find('textarea')[0].id
        $($(editor).parent().parent().find('textarea')[0]).html(txt)
        Updatedata($(editor).parent().parent().find('textarea')[0])
      }
    }
  });
});
var $popover = $(".BL, .devis, .CL")
var popover = new bootstrap.Popover($popover)

$(".CL").on('click', function(){
        var CL = $(this)
        console.log(CL, CL.attr('cl'))
        $("#offcanvasRightLabel").html("Détail du " + CL.attr('cl') + ":")
        $(".offcanvas-body").html('<h1><i class="fas fa-sun fa-spin" style="color:yellow"></i></h1>')
            $.ajax({
                 url: window.location.href,
                 data: {'CL_popover': CL.attr('cl')},
                 dataType: 'html',
                 type: 'post',
                 success: function (data) {
                    $(".offcanvas-body").html(data)
                 }
            })
})

$(".BL").on('click', function(){
        var BL = $(this)
        $("#offcanvasRightLabel").html("Détail du " + BL.attr('BL') + ":")
        $(".offcanvas-body").html('<h1><i class="fas fa-sun fa-spin" style="color:yellow"></i></h1>')
            $.ajax({
                 url: window.location.href,
                 data: {'BL_popover': BL.attr('BL')},
                 dataType: 'html',
                 type: 'post',
                 success: function (data) {
                    $(".offcanvas-body").html(data)
                 }
            })
})

$(".devis").on('click', function(){
        var devis = $(this)
        $("#offcanvasRightLabel").html("Détail du " + devis.attr('devis') + ":")
        $(".offcanvas-body").html('<h1><i class="fas fa-sun fa-spin" style="color:yellow"></i></h1>')
            $.ajax({
                 url: window.location.href,
                 data: {'devis_popover': devis.attr('devis')},
                 dataType: 'html',
                 type: 'post',
                 success: function (data) {
                    $(".offcanvas-body").html(data)
                 }
            })
})

function evalutionForm(userID){
  $.ajax({
    url: window.location.href,
    data: {'evalutionForm': userID},
    dataType: 'html',
    type: 'post',
    success: function (html) {
      $(".modal-body").find("div").hide()
      $("#ModalEvenementLabel").html("<h2>Evaluation</h2>")
      $("#enregister").html('Enregistrer')
      $("#evalutionFormDiv").html(html).fadeIn(500)      
    }
  })

}

</script>
{%endblock%}